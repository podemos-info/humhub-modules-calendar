humhub.module("calendar.Calendar",function(r,t,i){var e=t("ui.widget").Widget,a=t("client"),n=t("util").string,o=t("ui.loader"),l=t("ui.modal"),s=e.extend(),d=t("ui.view");s.prototype.init=function(){this.options.events={url:this.options.loadUrl,data:{selectors:this.options.selectors,filters:this.options.filters},error:function(t){r.log.error(t,!0)}},r.log.debug("Init calendar: ",this.options),this.initCalendarFilter(),this.updateCalendarFilters()},s.prototype.initCalendarFilter=function(){var t=this;i(".selectorCheckbox").click(function(){t.updateCalendarFilters(!0)}),i(".filterCheckbox").click(function(){"3"==i(this).val()&&i(":checkbox[value=4][name='filter']").attr("checked",!1),"4"==i(this).val()&&i(":checkbox[value=3][name='filter']").attr("checked",!1),t.updateCalendarFilters(!0)})},s.prototype.updateCalendarFilters=function(t){var e=[],o=[];i(".selectorCheckbox").each(function(){i(this).prop("checked")&&e.push(i(this).val())}),i(".filterCheckbox").each(function(){i(this).prop("checked")&&o.push(i(this).val())});var n=-1===this.options.loadUrl.indexOf("?")?"?":"&";this.options.events={url:this.options.loadUrl+n+i.param({selectors:e,filters:o}),error:function(t){r.log.error(t,!0)}},this.initFullCalendar(t)},s.prototype.initFullCalendar=function(t){this.fullCalendar&&t?(this.fullCalendar.removeAllEventSources(),this.fullCalendar.addEventSource(this.options.events)):(this.fullCalendar=new FullCalendar.Calendar(this.$[0],this.options),this.fullCalendar.render())},s.prototype.getDefaultOptions=function(){var t={};"today"!==r.text("button.today")&&(t.today=r.text("button.today")),"month"!==r.text("button.month")&&(t.month=r.text("button.month")),"week"!==r.text("button.week")&&(t.week=r.text("button.week")),"list"!==r.text("button.list")&&(t.list=r.text("button.list"));var e={header:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"},buttonText:t,plugins:["dayGrid","timeGrid","list","interaction","bootstrap","moment","momentTimezone"],defaultView:"dayGridMonth",aspectRatio:1.5,canCreate:!0,selectable:!0,select:i.proxy(this.select,this),eventAllow:function(){return!0},themeSystem:"bootstrap",loading:i.proxy(this.loader,this),eventResize:i.proxy(this.updateEvent,this),eventDrop:i.proxy(this.updateEvent,this),eventClick:i.proxy(this.clickEvent,this),eventRender:i.proxy(this.renderEvent,this)};return d.isSmall()&&(e.header={left:"prev,next",center:"title",right:"today"},e.footer={center:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"}),e},s.prototype.renderEvent=function(t,e){var o=i(e);o.attr({title:o.text()}),t.icon&&n.startsWith(t.icon,"fa-")&&o.find(".fc-content").prepend(i('<i class="fa '+t.icon+'"></i>'))},s.prototype.toJsonDateFormat=function(t,e){return e?FullCalendarMoment.toMoment(t,this.fullCalendar).format("YYYY-MM-DD"):FullCalendarMoment.toMoment(t,this.fullCalendar).format()},s.prototype.select=function(t){var e=this,o={data:{start:this.toJsonDateFormat(t.start,!1),end:this.toJsonDateFormat(t.end,!1),cal:1}},n=this.options.global?this.options.globalCreateUrl:this.options.editUrl;l.global.load(n,o).then(function(){l.global.$.one("hidden.bs.modal submitted",function(){e.fetch()})}).catch(function(t){l.global.close(),r.log.error(t,!0)}),this.fullCalendar.unselect()},s.prototype.fetch=function(){this.fullCalendar.refetchEvents()},s.prototype.updateEvent=function(e){var o=this,t=e.event,n=t.extendedProps,i={data:{id:t.id,start:this.toJsonDateFormat(t.start,t.allDay),end:this.toJsonDateFormat(t.end,t.allDay)}};this.loader(),a.post(n.updateUrl,i).then(function(t){t.success?r.log.success("saved"):r.log.error(t,!0),n.refreshAfterUpdate&&o.fetch()}).catch(function(t){r.log.error(t,!0),e.revert()}).finally(function(){o.loader(!1)})},s.prototype.clickEvent=function(t){var e=t.event.extendedProps;if(e.viewUrl){var o=this;"modal"===e.viewMode?l.global.load(e.viewUrl).then(function(){l.global.set({backdrop:!0}),l.global.$.one("hidden.bs.modal",function(){o.fetch()})}).catch(function(t){r.log.error(t,!0),l.global.close()}):a.pjax.redirect(e.viewUrl)}},s.prototype.loader=function(t){!1===t?o.reset(i("#calendar-overview-loader")):o.set(i("#calendar-overview-loader"),{size:"8px",css:{padding:"2px ",width:"60px"}})},r.export=s});